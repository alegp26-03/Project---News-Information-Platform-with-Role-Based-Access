<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>Share Information: <span th:text="${information.title}"></span></title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<style>
		body { padding: 20px; }
		.container { max-width: 700px; margin-top: 20px; }
		.user-list { max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 0.25rem; }
		.user-item { margin-bottom: 5px; }
		.share-link-section { /* Added style for the new section */
			background-color: #f8f9fa;
			border: 1px solid #e9ecef;
			border-radius: 0.25rem;
			padding: 15px;
			margin-top: 30px; /* Added some top margin for separation */
		}
	</style>
</head>
<body>
<div class="container">
	<h1 class="mb-4">Share Information: "<span th:text="${information.title}"></span>"</h1>
	<p>Owner: <strong th:text="${information.user.firstName + ' ' + information.user.lastName}"></strong> (<span th:text="${information.user.login}"></span>)</p>
	
	<form th:action="@{/information/share/{id}(id=${information.id})}" method="post">
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
		
		<div class="mb-4">
			<h5 class="mb-3">Currently Shared With:</h5>
			<div th:if="${currentSharedUsers.isEmpty()}" class="alert alert-info">Not shared with anyone yet.</div>
			<div th:unless="${currentSharedUsers.isEmpty()}" class="user-list mb-3">
				<div th:each="user : ${currentSharedUsers}" class="form-check user-item">
					<input class="form-check-input" type="checkbox" name="userIdsToRemove" th:value="${user.id}" th:id="${'removeUser' + user.id}" checked>
					<label class="form-check-label" th:for="${'removeUser' + user.id}">
						<span th:text="${user.firstName + ' ' + user.lastName}"></span> (<span th:text="${user.login}"></span>)
					</label>
				</div>
			</div>
			<small class="form-text text-muted">Uncheck users above to revoke sharing.</small>
		</div>
		
		<div class="mb-4">
			<h5 class="mb-3">Available Users to Share With:</h5>
			<div th:if="${availableUsers.isEmpty()}" class="alert alert-info">No other users available to share with.</div>
			<div th:unless="${availableUsers.isEmpty()}" class="user-list mb-3">
				<div th:each="user : ${availableUsers}" class="form-check user-item">
					<input class="form-check-input" type="checkbox" name="userIdsToAdd" th:value="${user.id}" th:id="${'addUser' + user.id}">
					<label class="form-check-label" th:for="${'addUser' + user.id}">
						<span th:text="${user.firstName + ' ' + user.lastName}"></span> (<span th:text="${user.login}"></span>)
					</label>
				</div>
			</div>
			<small class="form-text text-muted">Check users above to share this information.</small>
		</div>
		
		<button type="submit" class="btn btn-primary">Update Sharing</button>
		<a th:href="@{/information/list}" class="btn btn-secondary ms-2">Cancel</a>
	</form>
	
	<div class="share-link-section">
		<h3 class="mb-3">Share via Link</h3>
		<div th:if="${shareLink}"> <div class="input-group">
			<input type="text" class="form-control" id="shareLinkInput" th:value="${shareLink}" readonly>
			<button class="btn btn-outline-secondary" type="button" id="copyLinkButton">Copy Link</button>
		</div>
			<small class="form-text text-muted mt-2">Anyone registered and logged in can access this information via this link.</small>
		</div>
		<div th:unless="${shareLink}">
			<p class="text-muted">Generate a shareable link by updating sharing options (adding/removing users or saving existing changes).</p>
		</div>
	</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', function() {
		var copyLinkButton = document.getElementById('copyLinkButton');
		if (copyLinkButton) {
			copyLinkButton.addEventListener('click', function() {
				var copyText = document.getElementById('shareLinkInput');
				copyText.select();
				copyText.setSelectionRange(0, 99999); // For mobile devices
				navigator.clipboard.writeText(copyText.value)
						.then(() => {
							alert("Link copied to clipboard!");
						})
						.catch(err => {
							console.error('Failed to copy text: ', err);
							alert("Failed to copy link. Please copy it manually.");
						});
			});
		}
	});
</script>
</body>
</html>